version: '3.5'

services:

  ca_authority:

    container_name: ca_authority
    
    build:
      context: ./Certificate Authority

    entrypoint: /Scripts/post-compose.sh

    tty: true

    restart: always
    
    ports:
    - '80:80'

    networks:
      - internal
  
  koan: 
  
    container_name: Koan
    
    build:
      context: ./Koan

    # entrypoint: "/bin/bash"
    entrypoint: "mitmweb --web-host 0.0.0.0 --set block_global=false"
   
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv6.conf.all.forwarding=1
      - net.ipv6.conf.all.disable_ipv6=0
      - net.ipv4.conf.all.send_redirects=1

    cap_add:
          - ALL
          # - NET_ADMIN
          # - SYS_MODULE

    privileged: true

    restart: always

    environment:
      database: "${database}"
      TOR_CREDS: "${TOR_CREDS}"
      TOR_CRED_HASH: "${TOR_CRED_HASH}"
      # http_proxy: "${koan_http_proxy}"
    
    networks:
      - internal
      - external

    ports:
      - '8083:8081'
    
    depends_on:
      - ca_authority
  
  # ettercap:
  #   container_name: hack-ettercap
  #   image: mrecco/ettercap:latest
  #   command:
  #   - "-TbqM"
  #   - "arp"
  #   - "-oi"
  #   - "interface_name"
  #   network_mode: host
  #   pid: host
  #   # privileged: true
  #   cap_add:
  #   - NET_ADMIN
  #   - SYS_ADMIN
  #   stop_grace_period: 3s
  #   restart: always
  #   depends_on:
  #     - koan
  #   environment:
  #     # http_proxy: "${http_proxy}"
  #     database: "${database}"
  #   networks:
  #     - external

  houston: # Command and control

    container_name: Housten
    
    build:
      context: ./Houston
    
    entrypoint: /usr/bin/bash
    
    tty: true
    
    restart: always
    
    depends_on:
      - koan

    environment:
      http_proxy: "${http_proxy}"
      database: "${database}"

    networks:
      - internal


  database: # Data archiving

    container_name: Postgres
    
    # image: postgres:latest
    build:
      context: ./Database
    
    environment:  
      POSTGRES_USER: "${POSTGRES_USER}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
      POSTGRES_DB: "${POSTGRES_DB}"
    
    entrypoint: /Scripts/init.sh 

    tty: true
    
    restart: always
    
    depends_on:
      - koan

    volumes:
      - postgres-db:/var/lib/postgresql/data
      
    ports:
      - '5432:5432'
      
    networks:
      - internal

    user:
      postgres

  # databaseadmin:  

  #   image: dpage/pgadmin4
    
  #   environment:
  #     POSTGRES_USER: "${POSTGRES_USER}"
  #     POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
    
  #   entrypoint: /bin/sh
    
  #   tty: true
    
  #   restart: always

  #   networks:
  #     - internal

  #   depends_on:
  #     - koan
   

volumes:
  postgres-db:
    driver: local
    driver_opts:
        type: none
        o: bind
        device: C:\Users\User\MEGA\Docker\pagodo_and_proxychain\Database\data

  housten:
    driver: local
    driver_opts:
        type: none
        o: bind
        device: C:\Users\User\MEGA\Docker\pagodo_and_proxychain\Housten\data

networks:
    internal: # Internal network
        
        driver: bridge
        
        enable_ipv6: false
        
        # internal: true
        
        ipam:
            driver: default
           
            config:
                - subnet: 172.16.0.0/16
                  gateway: 172.16.0.1
    
    external: # Public facing network
       
        driver: bridge

        enable_ipv6: false
        
        driver_opts:
          com.docker.network.bridge.enable_ip_masquerade: "true"
        
        ipam:
            driver: default
            
            config:
                - subnet: 173.16.0.0/16
                  gateway: 173.16.0.1